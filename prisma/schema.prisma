generator client {
  provider  = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MERCHANT
  COURIER
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
}

enum OrderStatus {
  CREATED
  ASSIGNED
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  CANCELLED
  RETURNED
}

enum NotificationType {
  ORDER_STATUS_CHANGE
  ORDER_ASSIGNED
  PAYMENT_RECEIVED
  SYSTEM_ALERT
}

model Tenant {
  id        String       @id @default(uuid())
  name      String
  slug      String       @unique
  status    TenantStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Relationships
  users            User[]
  merchants        MerchantProfile[]
  couriers         CourierProfile[]
  orders           Order[]
  orderHistories   OrderHistory[]
  uploadedFiles    UploadedFile[]
  notifications    Notification[]

  @@map("tenants")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  role         UserRole
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Profile relationships
  merchantProfile MerchantProfile?
  courierProfile  CourierProfile?

  // Audit trail
  actionsPerformed OrderHistory[] @relation("ActionPerformer")
  notificationsReceived Notification[] @relation("NotificationRecipient")

  @@index([tenantId])
  @@map("users")
}

model MerchantProfile {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  
  companyName String
  balance     Decimal  @default(0) @db.Decimal(10, 2)
  
  orders      Order[]

  @@index([tenantId])
  @@map("merchant_profiles")
}

model CourierProfile {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  
  vehicleInfo String?
  wallet      Decimal  @default(0) @db.Decimal(10, 2)
  
  assignments Order[]

  @@index([tenantId])
  @@map("courier_profiles")
}

model Order {
  id             String      @id @default(uuid())
  trackingNumber String      @unique
  status         OrderStatus @default(CREATED)
  
  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Merchant who created the order
  merchantId String
  merchant   MerchantProfile @relation(fields: [merchantId], references: [id])

  // Courier assigned to the order
  courierId String?
  courier   CourierProfile? @relation(fields: [courierId], references: [id])

  // Recipient Details
  recipientName  String
  recipientPhone String
  address        String
  city           String
  
  // Financials
  price     Decimal @db.Decimal(10, 2)
  codAmount Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // History
  history OrderHistory[]
  uploadedFiles UploadedFile[]
  notifications Notification[]

  @@index([tenantId])
  @@index([merchantId])
  @@index([courierId])
  @@map("orders")
}

model OrderHistory {
  id        String      @id @default(uuid())
  orderId   String
  order     Order       @relation(fields: [orderId], references: [id])
  
  statusFrom OrderStatus
  statusTo   OrderStatus
  
  changedById String
  changedBy   User   @relation("ActionPerformer", fields: [changedById], references: [id])
  
  location    String?
  timestamp   DateTime @default(now())
  
  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  @@index([orderId])
  @@index([tenantId])
  @@map("order_histories")
}

model UploadedFile {
  id            String   @id @default(uuid())
  fileName      String
  fileType      String
  fileSize      Int
  fileCategory  String
  filePath      String   @unique
  
  // Multi-tenancy
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  
  // Optional: Link to order
  orderId       String?
  order         Order?   @relation(fields: [orderId], references: [id])
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([tenantId])
  @@index([orderId])
  @@map("uploaded_files")
}

model Notification {
  id          String            @id @default(uuid())
  type        NotificationType
  orderId     String
  order       Order             @relation(fields: [orderId], references: [id])
  status      OrderStatus?
  message     String
  isRead      Boolean           @default(false)
  
  // Recipient
  recipientId String?
  recipient   User?             @relation("NotificationRecipient", fields: [recipientId], references: [id])
  
  // Multi-tenancy
  tenantId    String
  tenant      Tenant            @relation(fields: [tenantId], references: [id])
  
  createdAt   DateTime          @default(now())
  
  @@index([tenantId])
  @@index([orderId])
  @@index([recipientId])
  @@map("notifications")
}
